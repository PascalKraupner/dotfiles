{{- if and (eq .chezmoi.os "linux") (or (eq .chezmoi.osRelease.id "arch") (eq .chezmoi.osRelease.id "cachyos")) -}}
#!/bin/bash
set -e

# List of GitHub repos to install as AppImages (owner/repo format)
# The latest x86_64 AppImage release will be resolved automatically
github_appimages=(
    "Dygmalab/Bazecor"
)

INSTALL_DIR="$HOME/Applications"
mkdir -p "$INSTALL_DIR"

install_or_update_appimage() {
    local repo="$1"
    local app_name
    app_name=$(basename "$repo")

    echo "[*] Resolving latest AppImage for $repo..."

    # Get latest release download URL for x86_64 AppImage
    local url
    url=$(curl -s "https://api.github.com/repos/$repo/releases/latest" \
        | jq -r '.assets[] | select(.name | test("x86_64|x64"; "i")) | select(.name | endswith(".AppImage")) | .browser_download_url' \
        | head -1)

    if [ -z "$url" ]; then
        echo "[!] Could not resolve AppImage URL for $repo, skipping."
        return
    fi

    local filename
    filename=$(basename "$url")
    local dest="$INSTALL_DIR/$filename"

    # Check if this exact version is already installed
    if app-manager --is-installed "$dest" 2>/dev/null | grep -q "installed"; then
        echo "[✔] $filename already installed — skipping."
        return
    fi

    # Uninstall any older version of this app
    local old_file
    old_file=$(find "$INSTALL_DIR" -maxdepth 1 -name "${app_name}*.AppImage" -o -name "${app_name}" 2>/dev/null | head -1)
    if [ -n "$old_file" ]; then
        echo "[*] Uninstalling old version: $old_file"
        app-manager uninstall "$old_file" 2>/dev/null || true
        rm -f "$old_file"
    fi

    echo "[*] Downloading $filename..."
    wget -O "$dest" "$url"
    chmod +x "$dest"

    echo "[*] Installing $filename..."
    app-manager install "$dest"
    echo "[✔] $filename installed."
}

for repo in "${github_appimages[@]}"; do
    install_or_update_appimage "$repo"
done

{{ end }}
